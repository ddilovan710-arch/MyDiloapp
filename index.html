<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>๐ฆ ุงูููุชุฌุงุช</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { background:#f9f9f9; }
    #reader { width:250px; margin:auto; }
  </style>
</head>
<body>

<!-- โ Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">๐ฆ ุงูููุชุฌุงุช</a>
    <div>
      <a class="btn btn-outline-light" href="sales.html">๐ ุงูุจูุน</a>
      <a class="btn btn-outline-light" href="profit.html">๐ฐ ุงูุฑุจุญ</a>
      <a class="btn btn-outline-light" href="history.html">๐ ุงูุณุฌู</a>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <h3 class="text-center">ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ</h3>

  <!-- โ ูุงููุฑุง ุงูุจุงุฑููุฏ -->
  <div id="reader"></div>
  <p class="text-center">๐ท ุงูุณุญ ุจุงุฑููุฏ ุงูููุชุฌ</p>
  
  <form id="productForm" class="mt-3">
    <input type="text" id="barcode" class="form-control mb-2" placeholder="ุงูุจุงุฑููุฏ" required>
    <input type="text" id="name" class="form-control mb-2" placeholder="ุงุณู ุงูููุชุฌ" required>
    <input type="number" id="price" class="form-control mb-2" placeholder="ุงูุณุนุฑ" required>
    <input type="number" id="qty" class="form-control mb-2" placeholder="ุงููููุฉ" required>
    <button type="submit" class="btn btn-success w-100">๐พ ุญูุธ</button>
  </form>

  <h4 class="mt-4">ูุงุฆูุฉ ุงูููุชุฌุงุช</h4>
  <table class="table table-bordered text-center">
    <thead>
      <tr>
        <th>ุงูุจุงุฑููุฏ</th>
        <th>ุงูุงุณู</th>
        <th>ุงูุณุนุฑ</th>
        <th>ุงููููุฉ</th>
        <th>ุงูุฅุฌูุงูู</th>
      </tr>
    </thead>
    <tbody id="productsTable"></tbody>
    <tfoot>
      <tr class="table-dark">
        <td colspan="4">ุฅุฌูุงูู ุงูููุชุฌุงุช</td>
        <td id="totalValue">0</td>
      </tr>
    </tfoot>
  </table>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbx3rQd6R7OQ1Wh2ynDoBSSHCSo4N7WvnTCSM5iTf0q3lzCl-ewPlOfSHNCKrPLCvHA/exec";

// โ ุชุดุบูู ุงููุงููุฑุง + ูุฑุงุกุฉ ุจุงุฑููุฏ
function startScanner() {
  const html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 200 },
    barcode => {
      document.getElementById("barcode").value = barcode;
      new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg").play();
      html5QrCode.stop();
    }
  );
}
startScanner();

// โ ุฅุฑุณุงู ุงูุจูุงูุงุช ููุชุฎุฒูู
document.getElementById("productForm").addEventListener("submit", async e => {
  e.preventDefault();
  const data = {
    barcode: document.getElementById("barcode").value,
    name: document.getElementById("name").value,
    price: parseFloat(document.getElementById("price").value),
    qty: parseInt(document.getElementById("qty").value),
    date: new Date().toLocaleString()
  };

  await fetch(API, {method:"POST", body: JSON.stringify(data)});
  alert("โ ุชู ุญูุธ ุงูููุชุฌ");
  loadProducts();
  e.target.reset();
  startScanner(); // ุฅุนุงุฏุฉ ุชุดุบูู ุงููุงููุฑุง
});

// โ ุชุญููู ุงูููุชุฌุงุช ูุนุฑุถ ุงูุฅุฌูุงูู
async function loadProducts(){
  const res = await fetch(API+"?action=getProducts");
  const rows = await res.json();
  let html="", total=0;
  rows.forEach(p=>{
    const sum = p.price * p.qty;
    total += sum;
    html += `<tr>
      <td>${p.barcode}</td>
      <td>${p.name}</td>
      <td>${p.price}</td>
      <td>${p.qty}</td>
      <td>${sum}</td>
    </tr>`;
  });
  document.getElementById("productsTable").innerHTML = html;
  document.getElementById("totalValue").innerText = total;
}
loadProducts();
</script>

</body>
</html>
